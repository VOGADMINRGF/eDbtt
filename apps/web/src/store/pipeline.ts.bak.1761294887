"use client";
import { useSyncExternalStore } from "react";

type Step = { id:string; label:string; status:"idle"|"run"|"ok"|"err"; ms?:number };
const steps = new Map<string, Step>();
let analyzing = false;
let ready = false;
let sub = new Set<() => void>();
const emit = ()=> sub.forEach(f=>f());

export function setAnalyzing(v:boolean){ analyzing=v; if(!v) ready=true; emit(); }
export function getAnalyzing(){ return analyzing; }
export function getReady(){ return ready; }
export function setStep(s:Step){ steps.set(s.id,s); emit(); }
export function reset(){ analyzing=false; ready=false; steps.clear(); emit(); }

export function usePipeline(){
  return useSyncExternalStore(
    (cb)=>{ sub.add(cb); return ()=>sub.delete(cb); },
    ()=>({ analyzing, ready, steps: Array.from(steps.values()) })
  );
}
