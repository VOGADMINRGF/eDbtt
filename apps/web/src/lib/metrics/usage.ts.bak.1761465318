import fs from "node:fs/promises";
import path from "node:path";

export type UsageEvent = {
  ts: number;
  route: string;
  userId: string | null;
  model: string | null;
  totalTokens: number | null;
  ms: number;
  ok: boolean;
  err: string | null;
  meta?: any;
};

const FILE = process.env.VOG_USAGE_FILE || ".next-cache/usage.log.jsonl";

export async function recordUsage(ev: UsageEvent) {
  try {
    await fs.mkdir(path.dirname(FILE), { recursive: true });
    await fs.appendFile(FILE, JSON.stringify(ev) + "\n", "utf8");
  } catch {
    // kein Crash im Fehlerfall
  }
}
