import "server-only";
import { coreCol } from "@core/db/triMongo";

/** Mongo-basierter Rate-Limiter (pro key/window) mit TTL-Index in CORE */
export async function rateLimit(key: string, max: number, windowMs: number) {
  const col = await coreCol<{ key:string; bucket:number; count:number; resetAt: Date }>("ratelimits");
  const now = new Date();
  const resetAt = new Date(now.getTime() + windowMs);
  const bucket = Math.floor(now.getTime() / windowMs);

  await col.createIndex({ key: 1, bucket: 1 }, { unique: true });
  await col.createIndex({ resetAt: 1 }, { expireAfterSeconds: 0 });

  const res = await col.findOneAndUpdate(
    { key, bucket },
    { $setOnInsert: { resetAt }, $inc: { count: 1 } },
    { upsert: true, returnDocument: "after" }
  );

  const count = res.value?.count ?? 1;
  const remaining = Math.max(0, max - count);
  return { ok: count <= max, remaining, resetAt };
}
