import fs from "node:fs/promises";
import { existsSync } from "node:fs";
import path from "node:path";

const WRITE = process.env.REPERATUR_WRITE === "1";
const logPath = "tools/reperatur/reports/tsc-web.log";
if (!existsSync(logPath)) {
  console.log("[19-ambient-decls] no tsc-web.log found, skip");
  process.exit(0);
}
const txt = await fs.readFile(logPath, "utf-8");
const pkgs = new Set();
for (const m of txt.matchAll(/TS2307: Cannot find module '([^']+)'/g)){
  const spec = m[1];
  if (spec.startsWith(".") || spec.startsWith("@/") || spec.startsWith("@features/")) continue;
  pkgs.add(spec);
}
if (pkgs.size === 0){
  console.log("[19-ambient-decls] nothing to declare");
  process.exit(0);
}

const dtsPath = "apps/web/src/types/ambient.auto.d.ts";
let out = `// AUTO-GENERATED by tools/reperatur/19-ambient-decls-from-log.mjs\n`;
for (const p of pkgs) out += `declare module "${p}";\n`;

await fs.mkdir(path.dirname(dtsPath), { recursive: true });
if (WRITE) await fs.writeFile(dtsPath, out, "utf-8");

console.log(`[19-ambient-decls] ${WRITE? "written":"dry-run"}; declarations: ${pkgs.size} â†’ ${dtsPath}`);
